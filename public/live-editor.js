const e="parent-handshake-acknowledge",t="contentstorage-set-config",n="contentstorage-set-highlight-content",o="contentstorage-set-hide-highlight-content",i="contentstorage-show-pending-changes",r="contentstorage-show-original-content",a="contentstorage-handshake-initiate",s="contentstorage-click-item-edit-btn",c="contentstorage-found-content-nodes",d=(e,t)=>{const n={type:e,payload:t};console.log("[Live editor] Sending message to parent:",n),window.parent.postMessage(n,"*")};const l=e=>/\{[^}]+\}/g.test(e),p=e=>{let t=e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");return t=t.replace(/\\{[^}]+\\}/g,"(.+?)"),t=t.trim(),new RegExp(t,"i")},u=(e,t)=>{if(l(t))try{return p(t).test(e.trim())}catch(n){return console.warn("[Live editor] Variable pattern matching failed:",n),e.includes(t)}return e.includes(t)};let m=!1;const g=(e,t)=>{Object.entries(t).forEach((([t,n])=>{e.style.setProperty(t,n,"important")}))},h=e=>{g(e,{"font-family":'system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',"font-size":"14px","font-weight":"normal","font-style":"normal","line-height":"normal",color:"inherit","text-decoration":"none","text-transform":"none","letter-spacing":"normal","text-align":"left","text-indent":"0","white-space":"normal","word-spacing":"normal",margin:"0",padding:"0",border:"none",outline:"none",background:"transparent","box-sizing":"border-box","vertical-align":"baseline","text-shadow":"none","box-shadow":"none",opacity:"1",visibility:"visible",overflow:"visible",transform:"none",transition:"none",animation:"none"})},f=(e,t)=>{if(e.nodeType===Node.TEXT_NODE&&e.textContent){const n=e.parentElement;if(n?.getAttribute("data-content-key")===t)return;const o=document.createElement("span");o.setAttribute("data-content-key",t),o.textContent=e.textContent;g(o,{display:"inline","box-sizing":"border-box"}),e.parentNode?.replaceChild(o,e)}else if(e.nodeType===Node.ELEMENT_NODE){const n=e;if(n.getAttribute("data-content-key")===t)return;n.setAttribute("data-content-key",t)}},y=e=>{if(e.nodeType===Node.TEXT_NODE&&e.textContent){const t=e.parentElement;if(t?.hasAttribute("data-content-checked"))return;const n=document.createElement("span");n.setAttribute("data-content-checked","true"),n.textContent=e.textContent,e.parentNode?.replaceChild(n,e)}else if(e.nodeType===Node.ELEMENT_NODE){const t=e;if(t.hasAttribute("data-content-checked"))return;t.setAttribute("data-content-checked","true")}},E=(e,t)=>{if(e.nodeType===Node.TEXT_NODE&&e.textContent?.trim()){const n=e.parentElement,o=n?.getAttribute("data-content-key");let i;return i=o?t.find((e=>e.contentKey.includes(o))):t.find((t=>("text"===t.type||"variation"===t.type)&&e.textContent&&u(e.textContent,t.text))),void(i?f(e,i.contentKey[i.contentKey.length-1]):y(e))}if(e.nodeType===Node.ELEMENT_NODE&&("IMG"===e.tagName||"INPUT"===e.tagName)){const n=e;let o;if("IMG"===n.tagName){const e=n;o=t.find((t=>"image"===t.type&&t.url===e.src))}else{const e=n,i=e.placeholder?.trim()||e.getAttribute("aria-label")?.trim();i&&(o=t.find((e=>"text"===e.type?u(i,e.text):"variation"===e.type?u(i,e.variation||e.text):void 0)))}return void(o?f(e,o.contentKey[o.contentKey.length-1]):y(e))}if(e.nodeType===Node.ELEMENT_NODE){const t=e;if(t.hasAttribute("data-content-key")||t.hasAttribute("data-content-checked"))return}const n=Array.from(e.childNodes);for(const e of n)E(e,t)},b=(e,t)=>{if(!m){m=!0;try{e&&e?.length>0&&E(document.body,e);document.querySelectorAll("[data-content-key]").forEach((e=>{const n=e.dataset.contentKey;if(!n||!t)return;const o=function(e){return e&&"IMG"===e.tagName}(e),i="INPUT"===e.tagName;let r,a=null;if(o)r=e.src;else if(i){const t=e;r=t.placeholder||t.getAttribute("aria-label")}else r=e.textContent;const c=e.getAttribute("data-content-showing-pending-change");if(!r)return;if(!c){let e=window.memoryMap.has(r);if(!e&&!o&&!i)for(const[t]of window.memoryMap)if(l(t))try{if(p(t).test(r.trim())){e=!0;break}}catch{continue}if(!e)return}if(o||i){const t=o?"contentstorage-element-image-wrapper":"contentstorage-element-input-wrapper",n=e.parentNode;if(n&&n.id===t)a=n;else{a=document.createElement("div"),a.setAttribute("id",t),h(a);g(a,{position:"relative",display:"inline-block","vertical-align":"baseline","max-width":"none","max-height":"none","min-width":"0","min-height":"0"}),e.parentNode&&(e.parentNode.insertBefore(a,e),a.appendChild(e))}g(a,{outline:"1px solid #1791FF","border-radius":o?"2px":"4px","outline-offset":"0"})}else{g(e,{outline:"1px solid #1791FF","outline-offset":"4px","border-radius":"2px",position:"relative"})}const u=a||e;if(u.querySelector("#contentstorage-element-label"))return;const m=document.createElement("div");m.setAttribute("id","contentstorage-element-label"),m.textContent=n,h(m);const f={position:"absolute",left:"calc(100% + 10px)",color:"#1791FF","font-size":"10px","font-weight":"400","font-family":'system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',"line-height":"1.2","z-index":"9999","pointer-events":"none","user-select":"none","white-space":"nowrap","text-align":"left",display:"block","max-width":"none",width:"auto",height:"auto"};i||o?f.bottom="0px":f.top="4px",g(m,f);const y=(e=>{const t=document.createElement("button");t.setAttribute("id","contentstorage-element-button"),t.type="button",h(t),g(t,{width:"30px",height:"30px",position:"absolute",top:"-25px",right:"-15px",cursor:"pointer",border:"1px solid #C0C0CA","background-color":"#EAF1F9","border-radius":"30px",display:"flex","justify-content":"center","align-items":"center",padding:"0",color:"#222225","z-index":"9999","min-width":"30px","min-height":"30px","max-width":"30px","max-height":"30px","flex-shrink":"0","user-select":"none","pointer-events":"auto","font-size":"0","line-height":"1"}),t.onclick=t=>{t.stopPropagation(),t.preventDefault(),d(s,{contentKey:e})};const n="http://www.w3.org/2000/svg",o=document.createElementNS(n,"svg");o.setAttribute("xmlns",n),o.setAttribute("viewBox","0 0 20 20"),o.setAttribute("fill","currentColor"),o.setAttribute("width","16"),o.setAttribute("height","16"),g(o,{display:"block","pointer-events":"none","user-select":"none","flex-shrink":"0",width:"16px",height:"16px","min-width":"16px","min-height":"16px","max-width":"16px","max-height":"16px",margin:"0",padding:"0",border:"none",outline:"none",background:"transparent","box-sizing":"border-box","vertical-align":"baseline",fill:"currentColor",stroke:"none","stroke-width":"0",opacity:"1",visibility:"visible",overflow:"visible",transform:"none",transition:"none",animation:"none",filter:"none","clip-path":"none",mask:"none"});const i=document.createElementNS(n,"path");return i.setAttribute("d","M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"),g(i,{fill:"currentColor",stroke:"none","stroke-width":"0",margin:"0",padding:"0",border:"none",outline:"none",background:"transparent","box-sizing":"border-box","vertical-align":"baseline",opacity:"1",visibility:"visible",transform:"none",transition:"none",animation:"none",filter:"none","clip-path":"none",mask:"none","pointer-events":"none","user-select":"none"}),o.appendChild(i),t.appendChild(o),t})(n);u.appendChild(m),u.appendChild(y)}))}finally{m=!1}}},N=e=>{e.forEach((e=>{const t=document.querySelector(`[data-content-key="${e.contentId}"]`);if(t){const n=t.childNodes;for(const o of n)if(o.nodeType===Node.TEXT_NODE&&o.textContent&&o.textContent.trim().length>0){(e.value?.toString()||"")&&e.langCountry===window.currentLanguageCode&&(t.setAttribute("data-content-showing-pending-change","true"),o.nodeValue=e.value?.toString()||"");break}}}))};let w={highlightEditableContent:!1,showPendingChanges:!1};const x=e=>{w={...w,...e}},T=()=>w,v=(e,t=!1,n=!1)=>!("checkVisibility"in e)||e.checkVisibility({checkOpacity:t,checkVisibilityCSS:n}),C=e=>!!e&&(!!e.isContentEditable||C(e.parentElement));let k=[];function A(e){if(e.nodeType!==Node.ELEMENT_NODE)return!1;const t=e;return t.hasAttribute("data-content-key")||t.hasAttribute("data-content-checked")}function L(){try{const e=(()=>{const e=[],t=e=>e instanceof HTMLScriptElement||e instanceof HTMLStyleElement||e instanceof HTMLTextAreaElement||e instanceof HTMLOptionElement||"NOSCRIPT"===e.tagName,n=!!document.querySelector('[contenteditable="true"]'),o=document.createTreeWalker(document.body,NodeFilter.SHOW_TEXT|NodeFilter.SHOW_ELEMENT,{acceptNode:e=>{if(e.nodeType===Node.ELEMENT_NODE){const o=e,i="IMG"===o.tagName,r="INPUT"===o.tagName&&(o.placeholder?.trim()||o.getAttribute("aria-label")?.trim());if(i||r){let e=o;for(;e&&e!==document.body;){if(e.hasAttribute("data-content-checked"))return NodeFilter.FILTER_REJECT;e=e.parentElement}return t(o)?NodeFilter.FILTER_REJECT:v(o)?n&&C(o)?NodeFilter.FILTER_REJECT:NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_REJECT}return NodeFilter.FILTER_SKIP}if(e.nodeType===Node.TEXT_NODE){if(!e.textContent?.trim())return NodeFilter.FILTER_SKIP;const o=e.parentElement;if(!o)return NodeFilter.FILTER_REJECT;let i=o;for(;i&&i!==document.body;){if(i.hasAttribute("data-content-checked"))return NodeFilter.FILTER_REJECT;i=i.parentElement}return t(o)?NodeFilter.FILTER_REJECT:v(o)?n&&C(o)?NodeFilter.FILTER_REJECT:NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_REJECT}return NodeFilter.FILTER_SKIP}});let i;for(;i=o.nextNode();)e.push(i);return e})();if(e.length>0){const t=e.map((e=>{if(e.nodeType===Node.TEXT_NODE&&e.textContent?.trim()){let t=window.memoryMap?.get(e.textContent);if(!t)for(const[n,o]of window.memoryMap)if(l(n))try{if(p(n).test(e.textContent.trim())){t=o;break}}catch{continue}const n=e.parentElement?.getAttribute("data-content-showing-pending-change");if(n){const n=e.parentElement?.getAttribute("data-content-key")||"";Array.from(window.memoryMap).forEach((e=>{e[1].ids.has(n)&&(t=e[1])}))}const o=Array.from(t?.ids||[]),i=t?.variation;if(0===o.length)return null;return{type:i?"variation":"text",text:e.textContent.trim(),contentKey:o,variation:i||""}}if(e.nodeType===Node.ELEMENT_NODE){const t=e;if("IMG"===t.tagName){const e=t,n=Array.from(window.memoryMap?.get(e.src)?.ids||[]);return 0===n.length?null:{type:"image",url:e.src,altText:e.alt,contentKey:n}}if("INPUT"===t.tagName){const e=t,n=e.placeholder?.trim()||e.getAttribute("aria-label")?.trim();if(!n)return null;const o=window.memoryMap?.get(n),i=Array.from(o?.ids||[]),r=o?.variation;if(0===i.length)return null;return{type:r?"variation":"text",text:n,contentKey:i,variation:r||""}}}return null})).filter(Boolean);console.log("[Live editor] Sending nodes to parent:",t),d(c,{contentNodes:t});const n=T().highlightEditableContent,o=T().showPendingChanges;b(t,void 0===n||n),o&&N([...k]),console.log("[Live editor] Significant mutation detected. Processing and sending text nodes.")}}catch(e){console.error("Error during DOM processing after mutation:",e)}}const S=function(e,t){let n,o=0;return(...i)=>{const r=Date.now();r-o>=t?(o=r,e(...i)):(n&&clearTimeout(n),n=window.setTimeout((()=>{o=Date.now(),e(...i)}),t-(r-o)))}}(((e,t)=>{let n=!1;const o=document.body,i=["contentstorage-element-label"],r=["style","class"],a=e.some((e=>"childList"===e.type&&Array.from(e.addedNodes).some(A)));for(const t of e){if("childList"===t.type){if(Array.from(t.addedNodes).some(A))continue}if(a&&"childList"===t.type){if(t.removedNodes.length>0&&0===t.addedNodes.length&&Array.from(t.removedNodes).every((e=>e.nodeType===Node.TEXT_NODE)))continue}if("attributes"===t.type&&r.includes(t.attributeName||"")){if(!t.target.hasAttribute("data-content-key"))continue}const e=t.target;if(e){let t=e.nodeType===Node.ELEMENT_NODE?e:e.parentElement;for(;t;){if(t.id&&i.includes(t.id)){n=!1;break}t=t.parentElement}if(t&&i.includes(t.id))continue}n=!0;break}n&&(t.disconnect(),L(),Promise.resolve().then((()=>{t.observe(o,F)})).catch((e=>{console.error("Error re-observing target node:",e)})))}),1e3),F={childList:!0,subtree:!0,attributes:!0};!function(){const s=document.currentScript;if(!s)return void console.error("CDN Script: Could not determine the current script element. This is necessary to read URL parameters from the script's own URL. Ensure the script is loaded via a standard <script> tag.");const c=s.src;console.log(`[Live editor] CDN Script loaded from ${c}`);let l=null;try{l=new URL(c).searchParams.get("contentstorage-live-editor")}catch(e){return void console.error("CDN Script: Could not parse script URL. Ensure it's a valid URL.",e)}if(l)if(window.parent&&window.parent!==window){console.log("[Live editor] Running inside an iframe. Setting up communication with parent and initiating handshake.");const s=new MutationObserver(S);let c,p=!1;const u=a=>{if(a.source===window.parent&&a.data)if(a.data.type===e)p||(p=!0,console.log("[Live editor] Received handshake acknowledgment from parent:",a.data.payload),d=a.data.payload.data.config,x(d),console.log("[Live editor] Set initial config:",d),d.highlightEditableContent&&b([],!0),console.log("[Live editor] Applied config:",a.data.payload),L(),console.log("[Live editor] Started observing DOM for mutations"),s.observe(document.body,F),console.log("[Live editor] Received handshake acknowledgment from parent:",a.data.payload),m(),console.log("[Live editor] Parent communication handshake successful. Ready for further messages."));else if(p){if(console.log("[Live editor] Received further message from parent:",a.data),a.data.type===t&&x(a.data.payload.data),a.data.type===n&&(x({highlightEditableContent:!0}),b([],!0)),a.data.type===o&&(x({highlightEditableContent:!1}),(()=>{const e=document.querySelectorAll("[data-content-key]"),t=document.querySelectorAll("#contentstorage-element-image-wrapper, #contentstorage-element-input-wrapper"),n=document.querySelectorAll("#contentstorage-element-label"),o=document.querySelectorAll("#contentstorage-element-button");t.forEach((e=>{const t=e.querySelector("img, input"),n=e.parentNode;n&&t&&(n.insertBefore(t,e),n.removeChild(e))})),e.forEach((e=>e.style.cssText="")),[...n,...o].forEach((e=>e.remove()))})()),a.data.type===i){const e=a.data.payload.data;c=e,k=[...c],x({showPendingChanges:!0}),N(e)}a.data.type===r&&(document.querySelectorAll('[data-content-showing-pending-change="true"]').forEach((e=>{const t=e.childNodes,n=e.getAttribute("data-content-key");for(const e of t)if(n&&e.nodeType===Node.TEXT_NODE&&e.textContent&&e.textContent.trim().length>0){const t=Array.from(window.memoryMap).find((([,e])=>e.ids.has(n)));t&&t.length>0&&"string"==typeof t[0]&&(e.nodeValue=t[0]||"");break}})),k=[],x({showPendingChanges:!1}))}else console.warn("CDN Script: Received message from parent before handshake was complete. Ignoring:",a.data);var c,d},m=()=>{c&&(clearTimeout(c),c=void 0)};window.addEventListener("message",u),d(a,`Hello from iframe script (editor param: ${l}). Initiating handshake.`),c=window.setTimeout((()=>{p||(console.warn("CDN Script: Parent communication handshake timed out. Parent did not respond or acknowledge correctly."),m())}),5e3)}else console.log("[Live editor] Not running inside an iframe, or parent is not accessible. Skipping parent communication setup.");else console.warn("CDN Script: The 'contentstorage-live-editor' URL parameter is MISSING in the script's src. This is a prerequisite. Halting further iframe-specific operations.")}();
